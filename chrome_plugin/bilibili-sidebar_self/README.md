# Bilibili 广告跳过工具

这是一个Chrome扩展，用于自动跳过哔哩哔哩(Bilibili)视频中的广告内容。

## 规划 todo list
- 增加API-KEY的输入，启动实时分析
- 增加有API-KEY了才弹出NOTION的KEY和Database的选项，用来匹配并操作标记

## 功能特点

- 自动检测和跳过视频中的广告
- 支持为每个视频单独设置广告时间段
- 自动保存广告时间段，再次观看时无需重复设置
- 支持通过URL参数共享广告时间段
- 简洁的界面，不影响正常使用
- 全局开关控制，随时可以启用/禁用功能
- UP主白名单功能，支持特定UP主视频手动跳过广告
- 管理员模式，用于高级设置和数据管理

## 安装步骤

1. 下载本项目并解压
2. 将SVG图标转换为PNG格式（需要使用图像编辑软件）
   - `icons/icon16.svg` -> `icons/icon16.png`
   - `icons/icon48.svg` -> `icons/icon48.png`
   - `icons/icon128.svg` -> `icons/icon128.png`
3. 打开Chrome浏览器，进入扩展管理页面（chrome://extensions/）
4. 开启"开发者模式"
5. 点击"加载已解压的扩展程序"
6. 选择项目文件夹

## 使用方法

1. 访问B站视频页面时，会在右上角显示"⏩ 广告跳过"按钮
2. 点击按钮设置广告时间段，格式: `开始-结束,开始-结束`
3. 例如: `61-87,120-145` 表示跳过61秒到87秒和120秒到145秒的广告
4. 点击"应用时间段"按钮使设置生效
5. 设置会自动保存，下次观看该视频时会自动跳过广告

### 全局开关

1. 点击"⏩ 广告跳过"按钮打开控制面板
2. 面板右上角有一个开关，可以临时启用/禁用广告跳过功能
3. 禁用后，即使设置了广告时间段也不会自动跳过
4. 此设置是全局的，会在所有打开的B站标签页间同步

### UP主白名单功能

1. 在视频页面点击"⏩ 广告跳过"按钮
2. 在控制面板中会显示当前UP主信息
3. 点击"加入白名单"可将当前UP主添加到白名单
4. 白名单中UP主的视频不会自动跳过广告，但仍可通过点击广告标记手动跳过
5. 已添加的UP主可以禁用、启用或从白名单中移除
6. 在扩展选项页面的"UP主白名单"选项卡可以管理所有白名单

### 管理员模式

管理员模式提供更高级的功能，如数据管理和调试：

1. 点击面板底部的"🔑 管理员登录"按钮
2. 输入正确的API密钥（需要向开发者获取）
3. 登录成功后，管理员按钮会显示为"🔧 管理员设置"
4. 点击该按钮可以打开管理面板
5. 管理员权限会在当前会话中保持（关闭浏览器后需重新登录）

## 通过URL分享

1. 在设置界面输入广告时间段后，点击"生成链接"按钮
2. 复制生成的链接分享给他人
3. 他人点击链接后，插件会自动应用广告跳过设置

## 常见问题

- **问题**: 设置了时间段但没有跳过广告
  **解决**: 确保开关处于打开状态，并且时间段设置正确且点击了"应用"按钮

- **问题**: 跳过了想看的内容
  **解决**: 调整时间段，避开想观看的内容，或临时关闭开关，或将UP主添加到白名单

- **问题**: 无法访问管理员功能
  **解决**: 联系插件开发者获取正确的API密钥

## 核心备忘录

### 跨页面状态同步机制
- 所有设置通过`chrome.storage.local`存储和同步
- 使用`chrome.storage.onChanged`监听器在不同页面间同步状态变化
- 关键状态包括：
  - `adskip_enabled`: 广告跳过功能开关状态
  - `adskip_debug_mode`: 调试模式状态
  - `adskip_percentage`: 广告跳过百分比设置
  - `adskip_uploader_whitelist`: UP主白名单数据
- **双向同步策略**：白名单状态变更在视频页面和全局设置页面间进行双向实时同步
- **恢复机制**：当检测到白名单数据不一致或丢失时，会重新检查并恢复正确的状态
- 重要：在调用页面特定函数前检查函数是否存在，避免跨页面状态同步错误

### 数据重置处理
- `选项页面`的`重置所有数据`按钮会清除：
  - 所有视频的广告时间戳数据
  - UP主白名单
  - 不会清除功能设置（如开关状态、跳过百分比）
- `视频页面`控制面板的`清空记录`按钮只清除：
  - 所有视频的广告时间戳数据
  - 保留白名单数据和功能设置

### UP主白名单功能设计
- 白名单控制简化为单个开关：启用/禁用白名单
- 当UP主不在白名单时，启用会自动添加该UP主
- 当UP主已在白名单但被禁用时，启用会恢复其状态
- 白名单UP主的视频不会自动跳过广告，但可以通过点击标记手动跳过

### 白名单数据结构
```javascript
[
  {
    name: "UP主名称",
    addedAt: 1679000000000, // 添加时间戳
    enabled: true          // 启用状态
  },
  // ...更多UP主
]
```

## 开发说明

这个扩展基于Chrome的API开发，主要使用了:
- `chrome.storage` - 保存用户设置和数据同步
- `chrome.tabs` - 获取当前标签页信息
- DOM操作 - 注入UI和监控视频播放
- 存储变更监听 - 实现跨页面状态同步

## 许可证

MIT

## 最近更新

### 日志节流优化
- 重构了白名单状态日志输出机制，添加节流控制避免重复日志刷屏
- 优化了`loadUploaderWhitelist`和`checkAndSkip`函数中的日志输出，仅在数据变化时记录日志
- 减少了不必要的控制台输出，降低性能开销和内存使用

### UI交互优化
- 重构了UI状态更新机制，使用原地无闪烁更新替代关闭重开面板
- 添加了CSS过渡动画，使UI状态变化更平滑自然
- 优化了白名单状态同步，无需刷新即可实时反映状态变化
- 改进了状态信息显示，使用淡入淡出效果替代静态文本

### 白名单UI优化
- 简化了视频页面的白名单控制界面，使用滑块开关替代按钮
- 改进了跨页面白名单状态同步，确保视频页面和设置页面的白名单状态实时同步
- 优化用户体验，减少空间占用，提供直观的白名单状态指示

### UP主白名单功能
- 支持将特定UP主添加到白名单，其视频不会自动跳过广告
- 提供白名单管理界面，可批量导入/导出白名单
- 支持启用/禁用白名单中的特定UP主
- 即使白名单UP主的视频不自动跳过广告，依然可以通过点击广告标记手动跳过

### 广告位可视化标记功能
- 现在会在视频进度条上标记出广告区间，让用户能直观看到广告所在位置
- 使用红色区域表示完整广告区间
- 使用蓝色区域表示触发广告跳过的实际区间（基于设置的百分比）
- 鼠标悬停在广告标记上可显示详细信息
- 点击广告标记可以手动跳过广告

### 代码优化
- 优化了DOM元素查询，减少重复查询提高性能
- 添加了视频播放器和进度条元素的缓存机制
- 优化了事件监听器的添加方式，避免重复添加匿名事件监听器
- 重构了部分代码，提高了可维护性
- 改进了跨页面状态同步机制，保证设置在所有页面保持一致

## 开发注意事项与常见问题

### 日志系统与性能
**日志频繁刷新的性能影响**:
- 每条日志都会占用内存空间，频繁日志会导致额外的内存开销
- 大量日志输出会增加JavaScript引擎垃圾回收的负担
- 控制台缓冲区可能会溢出，导致浏览器变慢或UI响应迟缓
- 频繁字符串拼接和格式化操作会占用CPU资源
- 对性能敏感操作(如视频播放)尤其应避免日志刷频

### Chrome扩展组件间同步问题
**Chrome扩展中组件间状态同步的挑战**:
1. **独立执行环境**: 不同页面(视频页面/设置页面)是完全隔离的JavaScript环境，无法直接共享变量
2. **数据传递机制**: 必须通过`chrome.storage`API进行数据共享，所有交互都是异步的
3. **事件监听与触发**: 接收方必须主动监听数据变化，发送方必须明确触发存储更新
4. **时序问题**: 多个页面同时修改同一数据可能造成覆盖，必须精心设计回调结构
5. **边界情况处理**: 白名单数据被删除等极端情况需要鲁棒性处理和恢复机制
6. **UI状态一致性**: 每个UI组件需要独立响应数据变化并更新界面，无法依赖单一状态管理

**可能的解决思路**:
- 采用类似Redux的集中式状态库模式，封装所有存储操作
- 实现双向数据绑定机制，确保UI与存储状态自动同步
- 为关键数据操作添加锁机制，防止并发修改冲突
- 定期同步数据验证，确保各组件状态一致
- 增强日志和调试工具，便于追踪跨组件交互问题